$.result=function(t,e,a,i,n){if(arguments.length<=3&&(i=!0),e in t){var s=t[e];return"function"==$.type(s)?s.apply(n||t,a):s}return i};var digitUppercase=function(t){var e=["角","分"],a=["零","壹","贰","叁","肆","伍","陆","柒","捌","玖"],i=[["元","万","亿"],["","拾","佰","仟"]],n=0>t?"欠":"";t=Math.abs(t);for(var s="",h=0;h<e.length;h++)s+=(a[Math.floor(10*t*Math.pow(10,h))%10]+e[h]).replace(/零./,"");s=s||"整",t=Math.floor(t);for(var h=0;h<i[0].length&&t>0;h++){for(var o="",d=0;d<i[1].length&&t>0;d++)o=a[t%10]+i[1][d]+o,t=Math.floor(t/10);s=o.replace(/(零.)*零$/,"").replace(/^$/,"零")+i[0][h]+s}return n+s.replace(/(零.)*零元/,"元").replace(/(零.)+/g,"零").replace(/^整$/,"零元整")};~function(t){t.fn.table=function(a){return this.each(function(){var i=t(this),n=new e(i,a);i.data("table",n)})};var e=function(e,a){if(t.extend(this,{key:"id",model:[],data:[],editData:function(t,e){e()},sync:function(t,e,a){a(e)},$table:e},a),"function"==t.type(this.data)){this._fetchData=this.data;var i=this;this._fetchData(function(t){i.data=t,i.init()})}else this.init()};t.extend(e.prototype,{init:function(){var e=this;this.actions=[],this.modelByName={},t.each(e.model,function(){var a=this;if(e.modelByName[a.name]=a,a.key&&(e.key=this.name),a.actions&&t.each(a.actions,function(){this.actionId||(this.actionId=e.actions.length,e.actions.push(this))}),a.select&&!a.format){var i={};t.each(this.select,function(t){t||a.defaultValue||(a.defaultValue=this[0]),i[this[0]]=this[1]}),a.format=function(t){return i[t||a.defaultValue]}}}),this.dataById={},this.guid=1,t.each(this.data,function(){e.indexData(this)}),this.actions.save={handler:this.saveRow},this.actions.edit={handler:this.editRow},this.actions["delete"]={handler:this.deleteRow},this.actions.cancel={handler:this.refreshRow},this.initStruct(),this.initEvent()},indexData:function(t){t.__id=this.guid++,this.dataById[t.__id]=t},initStruct:function(){this.$table.wrap('<div class="tb-table-wrapper">'),this.$root=this.$table.parent(),this.initHead(),this.initBody(),this.create!==!1&&this.createRow()},initHead:function(){var t=this;t.$head||(t.$head=t.$table.clone(),t.$head.empty().addClass("tb-head").wrap('<div class="tb-head-wrapper">'),t.$table.before(t.$head.parent())),t.$head.html(t.genRow())},resize:function(){this.$head.css({width:this.$table.outerWidth()}),this.$table.trigger("sizechange")},initBody:function(){var e=this;e.$body||(e.$body=t("<tbody>"),e.$table.wrap('<div class="tb-body-wrapper">'),e.$table.append(this.$body));var a="";t.each(e.data,function(){a+=e.genRow(this)}),this.$body.html(a)},genRow:function(e){var a="",i=this;return e?(a+='<tr class="tb-row" data-id="'+e.__id+'">',t.each(this.model,function(){var t=e[this.name];this.actions?t=i.genActions(this.actions,e):this.format&&(t=this.format(t,e)),t=null==t?"":t,a+='<td width="'+(this.width||"")+'">'+t+"</td>"})):(a+="<tr>",t.each(i.model,function(){a+='<th width="'+(this.width||"")+'">'+this.label+"</th>"})),a+="</tr>"},genActions:function(e,a){var i="";return t.each(e,function(){if(t.result(this,"show",[a],!0)){var e=t.result(this,"enable",[a],!0);i+="<a "+(e?" data-action="+this.actionId:"class=disabled")+" >"+t.result(this,"title",[a],"")+"</a> "}}),i},initEvent:function(){var e=this;this.$root.on("click","[data-action]",function(a){var i=t(this),n=i.closest("tr"),s=e.actions[i.data("action")],h=n.data("id"),o=e.dataById[h]||{};t.result(s,"handler",[o,n,a],!1,e)})},getRow:function(t){return this.$table.find("[data-id="+t+"]")},createRow:function(e){var a=this;e||(e={});var i=t(a.genRow(e));i.addClass("create"),a.$head.append(i),a.editRow(e,i),a.resize()},editRow:function(e,a){var i=this;a.addClass("edit"),a.find("td").each(function(a){var n=i.model[a],s=t(this),h=e[n.name];if(n.input&&s.html('<div class="td-control"><input placeholder="'+n.label+'" autocomplete="off" name="'+n.name+'" value="'+(null==h?"":h)+'"></div>'),n.select){var o='<div class="td-control"><select name="'+n.name+'">';t.each(n.select,function(){o+="<option "+(h==this[0]?"selected":"")+' value="'+this[0]+'">'+this[1]+"</option>"}),o+="</select></div>",s.html(o)}n.actions&&s.html('<a data-action="save">'+("__id"in e?"保存":"添加")+"</a> "+("__id"in e?'<a data-action="cancel">取消</a>':""))})},search:function(e){var a=this,i=a.$table.find(".tb-row:not(.create)");if(!e)return i.show(),void a.resize();var n=new RegExp(e,"g");i.each(function(){var e,i=t(this),s=a.dataById[i.data("id")];t.each(a.model,function(){if(this.search){var t=s[this.name];if(n.test(t))return void(e=!0);this.format&&(t=this.format(t,s),e=n.test(t))}}),i[e?"show":"hide"]()}),a.resize()},saveRow:function(e,a){var i=this,n=t.extend({},e),s=!e.__id;if(s)var h={};var o=!0;a.find("input,select").each(function(){var e=i.modelByName[this.name],a=t(this).val()||e.defaultValue;return e.validate&&e.validate(a)===!1?(o=!1,!1):(e.keepLastValue&&s&&(h[this.name]=a),void(n[this.name]=a))}),o&&i.sync(s?"create":"update",n,function(o){t.extend(e,n,o),s?(i.indexData(e),i.data.unshift(e),a.remove(),i.createRow(h),i.$body.prepend(i.genRow(e))):a.replaceWith(i.genRow(e)),i.resize()})},refreshRow:function(t,e){e.replaceWith(this.genRow(t))},deleteRow:function(e,a){var i=this;i.sync("delete",e,function(){a.remove();var n=t.inArray(e,i.data);i.data.splice(n,1),delete i.dataById[e.__id],i.resize()})}})}(jQuery);